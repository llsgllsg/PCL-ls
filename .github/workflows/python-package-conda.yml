# 工作流名称
name: 自动更新历史上的今天数据

# 触发条件：
# 1. 每天中国时间凌晨1点（UTC时间17:00，因为UTC+8=中国时间，所以1-8=-7 → UTC 17:00 = 中国次日1:00）
# 2. 手动触发（workflow_dispatch）
on:
  schedule:
    # cron表达式格式：分 时 日 月 周（UTC时间）
    # 中国时间凌晨1点 = UTC时间前一天17点 → 0 17 * * *
    - cron: '0 17 * * *'
  workflow_dispatch:  # 允许手动触发

# 工作流权限（最小权限原则）
permissions:
  contents: write  # 允许推送代码到仓库
  pull-requests: none

# 运行作业
jobs:
  update-history-data:
    # 运行环境：Ubuntu最新版
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出仓库代码
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          # 拉取全部分支历史（确保能推送）
          fetch-depth: 0

      # 步骤2：设置Python环境
      - name: 设置Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # 指定Python版本（兼容你的脚本）
          cache: 'pip'  # 缓存pip依赖，加速运行

      # 步骤3：安装依赖（requests库）
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 步骤4：运行Python脚本生成main.xaml
      - name: 运行脚本更新数据
        run: |
          # 运行你的Python脚本（替换为实际脚本文件名，比如history_update.py）
          python update_desc.py
          
          # 打印文件内容，验证是否生成成功（可选）
          cat main.xaml

      # 步骤5：提交并推送修改到仓库
      - name: 提交并推送更改
        run: |
          # 配置Git身份（必须，否则无法提交）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有文件变更
          if git status --porcelain | grep -q "main.xaml"; then
            # 添加修改的文件
            git add main.xaml
            # 提交说明
            git commit -m "feat: 自动更新历史上的今天数据 $(date +'%Y-%m-%d')"
            # 推送提交到仓库（默认推送到main分支，可根据你的分支名修改）
            git push origin main
            echo "✅ 数据更新并推送成功！"
          else
            echo "ℹ️  没有检测到main.xaml文件变更，无需推送。"
          fi
