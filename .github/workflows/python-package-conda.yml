# 工作流名称
name: 自动更新历史上的今天数据

# 触发条件：
# 1. 每天中国时间凌晨1点（UTC时间17:00）
# 2. 手动触发（workflow_dispatch）
on:
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = 中国时间 次日1:00
  workflow_dispatch:  # 允许手动触发

# 工作流权限
permissions:
  contents: write  # 允许推送代码到仓库

# 运行作业
jobs:
  update-history-data:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出仓库代码（必须先检出，否则找不到脚本）
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取全部分支历史

      # 步骤2：设置Python环境（移除cache配置，避免查找依赖文件）
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # 指定Python版本，和本地一致

      # 步骤3：安装依赖（直接安装requests，无需缓存）
      - name: 安装requests依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 步骤4：运行Python脚本生成main.xaml
      - name: 运行更新脚本
        run: |
          # 替换为你的Python脚本文件名（比如history_update.py）
          python history_update.py
          
          # 验证文件是否生成（可选，用于调试）
          ls -l main.xaml  # 查看文件是否存在
          cat main.xaml | head -20  # 打印前20行内容

      # 步骤5：提交并推送修改
      - name: 提交并推送更改
        run: |
          # 配置Git身份
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查main.xaml是否有变更
          if git status --porcelain | grep -q "main.xaml"; then
            git add main.xaml
            git commit -m "feat: 自动更新历史数据 $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main  # 分支名如果是master，改为master
            echo "✅ 数据更新并推送成功！"
          else
            echo "ℹ️  main.xaml无变更，无需推送"
          fi
